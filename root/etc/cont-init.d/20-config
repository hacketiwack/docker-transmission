#!/usr/bin/with-contenv bash

#Â Copy settings
cp -n /defaults/settings.json /config/settings.json
SETTINGS=$(< /config/settings.json)
DEFAULTS=$(< /defaults/settings.json)

# Set directories
SETTINGS=$(jq --arg key "download-dir" --argjson defaults "$DEFAULTS" -r '.[$key]=([.[$key], $defaults[$key]] | map(select(. | length > 0))[0])' <<< $SETTINGS)
SETTINGS=$(jq --arg key "incomplete-dir" --argjson defaults "$DEFAULTS" -r '.[$key]=([.[$key], $defaults[$key]] | map(select(. | length > 0))[0])' <<< $SETTINGS)
SETTINGS=$(jq --arg key "watch-dir" --argjson defaults "$DEFAULTS" -r '.[$key]=([.[$key], $defaults[$key]] | map(select(. | length > 0))[0])' <<< $SETTINGS)

# Set authentication
SETTINGS=$(jq --arg value "$USER" -r '."rpc-username"=$value' <<< $SETTINGS)
SETTINGS=$(jq --arg value "$PASS" -r '."rpc-password"=$value' <<< $SETTINGS)
SETTINGS=$(jq -r '."rpc-authentication-required"=((."rpc-username" | length > 0) and (."rpc-password" | length > 0))' <<< $SETTINGS)

# Set whitelist
SETTINGS=$(jq --arg value "$WHITELIST" -r '."rpc-whitelist"=$value' <<< $SETTINGS)
SETTINGS=$(jq -r '."rpc-whitelist-enabled"=(."rpc-whitelist" | length > 0)' <<< $SETTINGS)

# Set host whitelist
SETTINGS=$(jq --arg value "$HOST_WHITELIST" -r '."rpc-host-whitelist"=$value' <<< $SETTINGS)
SETTINGS=$(jq -r '."rpc-host-whitelist-enabled"=(."rpc-host-whitelist" | length > 0)' <<< $SETTINGS)

# Set peer port
SETTINGS=$(jq --arg value "$PEERPORT" -r '."peer-port"=([$value, ."peer-port"] | map(select(. | length > 0))[0] | tonumber)' <<< $SETTINGS)
SETTINGS=$(jq -r '."peer-port-random-on-start"=(."peer-port" | length == 0)' <<< $SETTINGS)

# Creates directories
install -o abc -g abc -d "$(jq -r '."download-dir"' <<< $SETTINGS)"
install -o abc -g abc -d "$(jq -r '."incomplete-dir"' <<< $SETTINGS)"
install -o abc -g abc -d "$(jq -r '."watch-dir"' <<< $SETTINGS)"

# Save configuration
echo $SETTINGS > /config/settings.json
chown abc:abc config/settings.json
